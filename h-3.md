# h3 Lab kid

Kone millä tein harjoituksen:

AMD Ryzen 2600X Six-Core Processor 3.6 ghz  

16gb RAM  

Windows 10 Pro 64-bit käyttöjärjestelmä  

Oracle VM VirtualBox Manager

##

Läksy löytyy sivulta:  

https://terokarvinen.com/2023/eettinen-hakkerointi-2023/  

## x) Lue ja tiivistä  


https://learning.oreilly.com/library/view/mastering-kali-linux/9781801819770/Text/Chapter_10.xhtml#_idParaDest-248  

- Metasploit Framework on open-source työkalu tunkeutumistestausta varten Ruby kielellä   
- Framework on jakautunut libraries, interfaces ja modules  
- Libraries /usr/share/Metasploit-framework/lib/   
- sudo msfconsole pääsee console interfaceen  
- modules (exploits, payloads, auxiliary modules, post modules, encoders, no operations)  
- choose and configure exploit, check target system, choose and configure the payload,choose encoding technique to bypass detection controls, execute exploit  
- database setup ja konfiguraatio, nmap scannaus, hyökkääminen exploitilla  
- meterpreter interaktiivinen shelli millä voi hyökätä ja ajaa koodia targetilla  
- exploit db julkinen tietokanta missä exploitteja eri softaversioille / searchsploitilla voi etsiä kalissa näitä / miten exploitit ajetaan


HTB PRECIOUS: https://0xdf.gitlab.io/2023/05/20/htb-precious.html  

- tavalline nettisivu minkä pitäisi generoida urli tiedostosta pdf-tiedosto  
- käytetään metadataa pdf-tiedostosta löydettääksi mitä teknologiaa käytetään, commadn injection exploitti millä päästään boxiin, etsitään credentialsit ruby bundler  
tiedostosta millä päästään käyttäjän tietoihin   
- roottiin päästäkseen käytetään yaml deserialization vulnerability scriptiä   
- rootissa tarkastellaan weppiapplikaatiota, mite se o hostattu, ja fixataan bugi mikä antaa luvan generoida pdf sivuston itse  
- nmap portit (ssh ja http auki), open ssh debian 11 bullseye  
- ffuz subdomain brute force, ei löydä mitään muuta, sivu on siis precious.htb  
- exiftool löytää Creator by pdfkit v.0.8.6   
- löytää googlesta hakemalla Snyk articlen missä exploitti pdfkittiin  
- pääsee shelliin ja vaihtaa shellin script and stty   
- käyttäjän löytö jap ääsy: ruby config filestä löytää henry käyttäjän ja salasanan --> pääsy sisään käyttäjälle  
- sudo -l , löytyy update_depencies.rb tiedoston -> depencies.yml tiedosto --> löytyy rootin id -> tallentaa update_dependencies.rb tiedostoon --> pääsee shelliin missä root  
- löytää DNS ongelman, josta selviää miten saa korjattua, että sivustosta saa pdf version

Nyrkkeilysäkki:

Googlasin "tero karvinen nyrkkeilysäkki" ja löysin tämän mielestäni selkeän raportin:  
  
https://myllys.wordpress.com/tunkeutumistestaus-2021-syksy-harjoitus-2/  

- lataa metasploit 2 https://sourceforge.net/projects/metasploitable/ ; ja asenna se virtualboxiin  
- host-only verkon luonti, Kali linuxin VB settingseistä uusi hosti adapteri, kalin saa pois netistä raksimalla cable connected pois päältä  
- metasploit VB network settings, Adapter 1 Host-only adapter,  Kali Linux adapter 2 host only adapter päälle  
- Kalista pingataan nettiin ja tarkistetaan, että ei ole päällä. Kalista pingataan Metasploit koneeseen ja tarkistetaan, että yhteys toimii

##

## a) Asenna Kali virtuaalikoneeseen  

Olin jo aikasemmin asentanut Kali Linuxin.

Raporttini tehtävästä löytyy: https://github.com/aarott/pentest23/blob/main/h-1.md#d-asenna-linux-virtuaalikoneeseen  

##

## b) Asenna Metasploitable 2 virtuaalikoneeseen  

Ohjeet Metasploitin asennukseen löysin https://myllys.wordpress.com/tunkeutumistestaus-2021-syksy-harjoitus-2/ raportista.  

Menin https://sourceforge.net/projects/metasploitable/ ja painoin Download.

Zippi tiedoston purettua huomasin, että kansiossa on suoraan Virtual Box Hard Disk file.  

Menin Virtual Boxiin --> New  

Name and operating system laitoin Metasploitable 2 ja Linux 64-bit. 

Valitsin hard disk ja use an existing hard disk -> tänne sitten sen Metasploitin hard disk tiedosto ja Finish.  

##  

![image](https://github.com/aarott/pentest23/assets/78908566/23af0e61-4e14-449d-ba0b-dd8f3313866d)  

##  

![image](https://github.com/aarott/pentest23/assets/78908566/93cd98a9-612f-4f59-99e7-1b72f561eca9)    

##  

![image](https://github.com/aarott/pentest23/assets/78908566/f05d7d33-f7ff-4186-b49c-20be7c49133b)    

##  

Nyt Metasploitable 2 näkyy VirtualBox Managerissa, käynnistin sen ja näyttäisi toimivan.  

##

## c) Koneille virtuaaliverkko  

Tehtävän ohjeissa pitää tehdä virtuaaliverkko, jossa  

- Kali saa yhteyden Internettiin, mutta sen voi laittaa pois päältä  
- Kalin ja Metasploitablen välillä on host-only network, niin että porttiskannatessa ym. koneet on eristetty intenetistä, mutta ne saavat yhteyden toisiinsa  
- Osoita eri komennoilla, että Internet-yhteys katkeaa: 'ping 1.1.1.1', 'ping www.google.com', 'curl www.google.com'  

Käytin taas https://myllys.wordpress.com/tunkeutumistestaus-2021-syksy-harjoitus-2/ raporttia avukseni tässä tehtävässä.  

VirtualBoxissa menin Network settingseihin ja menin luomaan uuuden Host-Only Networkin. Asetuksista laitoin päälle DHCP:n, jotta laitteet määrittää automaattisesti IP-osoitteet.  

##

![image](https://github.com/aarott/pentest23/assets/78908566/013b2d01-98d1-45da-b289-a266ea52674b)  

##

Menin VirtualBoxin Metasploitable 2 settings -> Network -> Adapter 1 -> valitsin tähän nyt äsken määritetyn uuden Host-Only adapterin.  

##

![image](https://github.com/aarott/pentest23/assets/78908566/3c895862-557c-4510-bdfa-9e03ac356daa)

##

Menin VirtualBoxin Kali settings -> Network -> Adapter 2 -> valitsin tähän nyt äsken määritetyn uuden Host-Only adapterin. 

* Huom sitten kun Kali halutaan ottaa pois netistä niin Adapter 1 kohdassa ruksataan pois kohta Cable Connected.

![image](https://github.com/aarott/pentest23/assets/78908566/f758c759-fcea-4082-b840-7c35c37a1ee5)  

![image](https://github.com/aarott/pentest23/assets/78908566/f0f27d82-7117-463c-81b1-a2be96e81ad4)  

##  


Käynnistin Kali Linuxin ja Metasploitable 2 koneet päälle.  

Pikaisesti piti googlettaa miten Metasploitable 2 koneeseen pääsee sisään. Metasploitable2 koneen käyttäjä ja salasana on sama `msfadmin`. 

Pingasin Teron kotisivua ja tarkistin, että kone ei saa yhteyttä nettiin. Ajoin sen jälkeen komennon `ifconfig` mistä sain ip-osoitteen mitä voidaan pingata Kalilla ja testata, että yhteys toimii.  

![image](https://github.com/aarott/pentest23/assets/78908566/603567ae-75d3-4cd7-a9e6-de25b68fbf26)  


Metasploitable 2 koneen ip-osoite on: 192.168.78.4

Menin sitten Kaliin pingasin taas Teron kotisivua tarkistaakseni, että netti ei toimi. Kokeilin myös curl google.com.  Sen jälkeen pingasin Metasploitable 2 konetta joka vastasi onnistuneesti.  

![image](https://github.com/aarott/pentest23/assets/78908566/50c2d936-a957-4651-bca8-80e9bee700d5)


##  d)  Etsi Metasploit porttiskannaamalla  

Menin ensiksi Kalilla metasploitin consoleen komennolla `msfconsole` 
Yritin ajaa komennon `db_nmap -sn ip` mutta sain vastaukseksi, että "database not connected".  

##

![image](https://github.com/aarott/pentest23/assets/78908566/508bd904-4940-4920-9925-7ed2227ae010)  

##

Googletin ja otin ekasta linkistä ohjeet https://miteshshah.github.io/linux/kali/how-to-fix-metasploit-database-not-connected-or-cache-not-built/  

Ajoin komennot: 

`$ sudo service postgresql start`  
`$ sudo msfdb init`  
`$ db_status`  

![image](https://github.com/aarott/pentest23/assets/78908566/bd423b4c-337e-460f-9076-c34cb14cbe66)

##  

Nyt kokeilin db_nmap uudestaan ja toimii.  Tarkistin selaimella ip-osoitetta, että löysin oikean osoitteen Metasploitable weppi-palvelimelle.  

![image](https://github.com/aarott/pentest23/assets/78908566/94886e85-7189-45f6-a919-7d81e4aeff72)  

##  

![image](https://github.com/aarott/pentest23/assets/78908566/612f440f-eeda-47aa-889c-2c01ad0089df)  

##  

## e) Porttiskannaa Metasploitable huolellisesti (db_nmap -A -p0-)  

Lähdin porttiskannaamaan  `db_nmap -A -p0- 192.168.78.4`  

db_nmap = sama kuin nmap, porttiskannaus komento ja tallentaa lisäksi tuloksen tietokantaan  
-A = agressiivinen laaja skannaus  
-p0- = tarkoittaa kaikki portit 0 mukaanlukien  

Eka ei tuntunut muutamaan minuuttiin tapahtuvan mitään, sitten tuli pitkä lista skannauksen tuloksia. 
Jatkan näiden analyysiä myöhemmin.  

Pikaisesti skannauksen tulosta katsoessani huomasin että on paljon palveluita missä: 

- ei ole uusinta versiota palvelusta
- palvelua ei yksinkertaisesti enää ole käytössä tietoturvariskien takia,  vaan on uudempia turvallisempia vastaavia nykyään käytössä
- on palveluita missä on auki käyttö tuntemattomille käyttäjille

Aloitan nyt listan alusta ja käyn läpi mitä tiedän, käytin joidenki palveluiden kohdalla pikaisesti googlen-hakua avuksi selvittääkseni mistä palvelusta on kyse.  

Koska lista on pitkä olen jakanut tämän muutamaan osaan, missä on ruuttukaappaus kohdasta ja analyysiä mitä on näkyvillä.  

##

![image](https://github.com/aarott/pentest23/assets/78908566/bcce65e0-f004-4c41-85fd-a1310173d737)
 

##

- Port 21/tcp FTP version vsftpd 2.3.4 

Tästä vsftpd 2.3.4 on yleinen haavoittoivuus tiedossa: https://www.rapid7.com/db/modules/exploit/unix/ftp/vsftpd_234_backdoor/  mikä lisää backdoorin palveluun.  
_ftp_anon: Anononymous FTP Login allowed = tämä käytännössä antaa kenen tahansa kirjautua sisään mikä ei voi olla hyvä asia  

- Port 22/tcp open ssh Open SSH 4.7p1  

SSH-yhteyden pitäisi olla turvallinen mutta tämä on vanha versio palvelusta mistä on tunnettu löydetty haavoittuvuus mikä murtautuu brute force hyökkäyksellä:  

https://www.linkedin.com/pulse/custom-exploit-python-how-i-exploited-port-22-metasploitable-g  

- Port 23/tcp telnet

Sen verran tiedän, että telnet on ikiaikainen, eikä käytössä enää ja varmaan täynnä haavoittuvuuksia. SSH nykyään tilalla. 

- Port 25/tcp SMTP

Smtp palvelua käytetään sähköposteihin. Nopeesti selvitin mikä tässä voisi olla haavoittuvuus. Se ainakin, että avonainen STMP portissa 25 mahdollistaa SPAM-sähköpostin lähettämisen koneista joihin on murtauduttu.  

##  

![image](https://github.com/aarott/pentest23/assets/78908566/6f793369-ed00-4544-a1e1-01f8261748f1)  
  

## 

SSLV2 pistää silmään, koska se ei ole uusin versio SSL:stä joka on tärkeä suojausprotokolla. Uusin ja tietysti turvallisin versio mitä tulisi käyttää on 3.1 tällä hetkellä.  

- Port 53/tcp Domain ISC BIND 9.4.2

Tähän löytyy haavoittuvuus suoraan ExploitDB: https://www.exploit-db.com/exploits/6122  

- Port 80/tcp HTTP Apache httpd 2.2.8  

Vanha versio Apachesta, varmasti on haavoittuvuuksia.  

- Port 111/tcp RPC Bind

Haavoittuvuus: https://hackerone.com/reports/791893  

- Portit 512/513/514  

Exec, login, shell palveluita minkä portit on auki. Vaikuttaa huonolta, että kyseisten palveluiden portit on auki.   

- Port: 2121 FTP

Nykyään käytetään turvallisempaa FTPS.  

##  

![image](https://github.com/aarott/pentest23/assets/78908566/c28cf858-2e3d-4bf1-860d-18df51001648)  

##  

- Port 3306/tcp mysql  

Lopusta voidaan lukea, että ssl-certifikaatti on "NOT VALID AFTER" eli vanhenut jo vuonna 2010 , joten palvelu ei voi olla turvallinen. 

##  

![image](https://github.com/aarott/pentest23/assets/78908566/1d06d33f-181b-404c-b246-3978e6b9c9cf)  

##

- Port 5900/tcp VNC (protocol 3.3)

VNC on tietääkseni remote desktop palvelu missä voi hallita toisen käyttäjän konetta työpöydällä kuin omanaan. Protokolla versio on ilmeisesti vanha tässä ja  
exploitti löytyy https://www.rapid7.com/db/modules/exploit/windows/vnc/realvnc_client/  

- Portit tcp 8009/8180 vanhoja versioita Apachesta jotka ei välttämättä turvallisia.  

- Portit tcp 8787/45177/46278/49058/53801  kaikista löytyy google-haun mukaan vulnerabilities. En näitä kaikkia tarkemmin selvitellyt, eivät ainakaan olleet tuttuja millään tapaa.

- Host script results:  

 smb-security-mode  
message_signing: disabled (dangerous, but default)  

Tässä lukee selvästi, että on vaarallista että tuo message_signing on pois päältä. Joku haavoittuvuus tässäkin siis on.  

##  

## f) Murtaudu Metasploitablen VsFtpd-palveluun Metasploitilla (search vsftpd, use 0, set RHOSTS - varmista osoite huolella, exploit, id)  

Muistaakseni Tero näytti tämän tunnin lopussa, joten koitin tehdä tämän ulkomuistista.  

`search vsftpd` 

Tämä tuotti tuloksen:  

![image](https://github.com/aarott/pentest23/assets/78908566/dbf3fb14-99a9-43ab-88b7-8afb4b878b98)

##

Listasta käytetään tietenkin # 1 vaihtoehtoa koska se on rankattu "Excellent". Se on juuri tuo 2.3.4 Backdoor Command Execution.  

`use 1`

`set rhosts 192.168.78.4`  

`run`

Päästiin shelliin roottina :)  

##  

![image](https://github.com/aarott/pentest23/assets/78908566/ade2b42d-59eb-4ce8-aba5-639f91ff3055)  


##

## g) Parempi sessio. Tee vsftpd-hyökkäyksestä saadusta sessiosta parempi. (Voit esimerkiksi päivittää sen meterpreter-sessioksi, laittaa tty:n toimimaan tai tehdä uuden käyttäjän ja ottaa yhteyden jollain tavallisella protokollalla)  

https://infosecwriteups.com/metasploit-upgrade-normal-shell-to-meterpreter-shell-2f09be895646  

Kyseisen artikkelin ohjeiden mukaan päivitin meterpreter-sessioksi.  

`Ctrl+Z` --> saadaan sessio taustalle sulkematta sitä  

`search shell_to_meterpreter` 

`use 0` --> löytyy tämä ainoa shelli mikä on auki ja otetaan se

`sessions -l`  

`set session 1`  

`run` 

`sessions -i 1` 

Ei kuitenkaan toimi, enkä pääse Meterpreter-sessioon vaikka kuinka seuraan ohjetta ja olen koittanut jo kerran kokonaan uudelleen. Koitan katsoa tätä vielä myöhemmin uusilla silmillä tai viimeistään kysyä tunnilla.  
Vinkkejä otetaan vastaan...  

##

![image](https://github.com/aarott/pentest23/assets/78908566/d6222843-3d80-4b10-951e-fa1d3c530eee)

##

Katsoin Teron sivun tehtävän vinkeistä "ctrl-Z, sessions, session -u 1, session 1 (ulkomuistista)" tällä ilmeisesti pääsisi meterpreteriin.  
Kokeilin taas uudestaan ja törmään edelleen samaan ongelmaan kuin aikasemmin, meterpreterin sijaan tulee teksti "Stopping exploit/multi/handler". Ollaan kuitenkin hyökätyn koneen rootissa edelleen.  

##

ctrl-Z, sessions, session -u 1, session 1 (ulkomuistista)  


![image](https://github.com/aarott/pentest23/assets/78908566/7a3c0035-a532-4660-a3eb-028f8ebffba3)  


##

## h)  Etsi, tutki ja kuvaile jokin hyökkäys ExploitDB:sta  

https://www.exploit-db.com/exploits/33145  

Kyseessä on PHP Fuzzer Framework - Default Location Insecure Temporary File Creation exploitti.  

Exploitin on tarkoitus luoda väliaikaisia tiedostoja (temporary files) vaarallisella tavalla. 

Jos hyökkääjällä on pääsy kohteen koneeseen, tällaisten tiedostojen kirjoittaminen voi vaarantaa sovelluksia tai koko käyttöjärjestelmän.  

Koodi on kirjoitettu C-kielellä.  

Koodista saa selville, että siellä ajetaan kahta tiedostoa FILEA ja FILEB kohteen koneeseen.  

![image](https://github.com/aarott/pentest23/assets/78908566/1b7dcd0d-d7ab-404c-8b5e-d00a69613796)  


##

## i) Etsi, tutki ja kuvaile hyökkäys 'searchsploit' -komennolla. Muista päivittää.  

https://www.exploit-db.com/searchsploit  

https://www.youtube.com/watch?v=nx3Uz9zNrWQ  katsoin tällasen videon mikä kertoi nopeasti miten searchsploittia voi käyttää

Laitoin tätä tehtävää varten Kali Linuxin verkkoon VirtualBoxin settingseistä, että pääsen päivittämään sen.  

`sudo apt-get update`  
`sudo apt-get uprage`   
`searchsploit -u` -> kyseinen komento päivittää exploitdb packagen  

Päätin etsiä OpenSSH 4.7 exploitteja, koska aikaisemmassa tehtävässä e) Metasploitable2 koneen Nmap skannauksessa löytyi haavoittuutena tämä palvelu. 

`searchsploit OpenSSH 4.7`  

`searchsploit --help` tämä on hyödyllinen koska kertaa valinnoista mitä voi tehdä. Tässä kaksi olennaisinta mielestä on:  

-x = examine exploit, voidaan tarkastella exploitin sisältöä enne kopioimista esim   
-m = kopioi exploitin nykyiseen working directory

##

![image](https://github.com/aarott/pentest23/assets/78908566/ffc4116c-7835-42ed-9c08-132500df5070)  

##  

`searchsploit OpenSSH 4.7`  

##

![image](https://github.com/aarott/pentest23/assets/78908566/e0ec8dca-5d24-4f6a-8895-50afeb6ff0a9)
 

##

Tarkastellaan nyt OpenSSH < 6.6 SFTP - Command Execution exploit tiedosto.  

`searchsploit -x linux/remote/45001.py`   

##  

![image](https://github.com/aarott/pentest23/assets/78908566/35e8ea29-f2da-4520-89e0-c3f73d049009)  

##  

![image](https://github.com/aarott/pentest23/assets/78908566/2cb9178b-cf87-48e1-9be1-3d70e2829684)  

##

Kysessä on siis Python kiellä kirjoitettu exploit tiedosto.  

https://seclists.org/fulldisclosure/2014/Oct/35  

Exploitti antaa siis tavan miskonfiguroida palvelin ja antaa käyttäjälle pääsy kaikkiin eri filesystem alueisiin.  

Tällä koodilla yritetään päästä /proc/self/maps kansioon, että voidaan paljastaa "memory layout" ja kirjoittaa omavalintaisia paikkoja muistille.  

##

## j) Kokeile vapaavalintaista haavoittuvuusskanneria johonkin Metasploitablen palveluun. (Esim. nikto, wpscan, openvas, nessus, nucleus tai joku muu)  

Sammutin Kali Linuxin ja menin Virtual Boxin settingseihin taas laittamaan yhteyden nettiin pois päältä (cable connected pois) ja laittamaan host-only networking toimintaan MetaSploitable 2 koneen kanssa.  

Aion kokeilla Nikto scanneria ja skannata sillä Metasploitable 2 kone.  

https://www.freecodecamp.org/news/an-introduction-to-web-server-scanning-with-nikto/  


`nikto -help` saadaan tietoa komennon eri vaihtoehdoista  

`nikto -h 192.168.78.4` skannataan Metasploitable2 kone portti 80 (http webserver)    

##  

![image](https://github.com/aarott/pentest23/assets/78908566/3c89a3e9-aff1-4c89-aea1-fc80aa7eb7a3)  

##  

Tulos antaa weppipalvelimen kaikki mahdolliset haavoittuvuudet. Haavoittovuudet on myös kerrottu hyvin selkeästi esim:  

##  

![image](https://github.com/aarott/pentest23/assets/78908566/09c59fbf-13c5-4b6b-8320-9ea8ac01c520)  

##  

Tämä kertoo suoraan, että Apache ei ole päivitetty uusimpaan versioon.   
Palvelin vastaa "junk HTTP methods" joka saattaa antaa vääriä positiviisia vastauksia.  
HTTP Trace aktiivisena voi olla haavoittuvainen.  

##  

## k) Kokeile jotain itsellesi uutta työkalua, joka mainittiin x-kohdan läpikävelyohjeessa.  












 




