# h2 Sniff-n-Scan

Kone millä tein harjoituksen:

AMD Ryzen 2600X Six-Core Processor 3.6 ghz  

16gb RAM  

Windows 10 Pro 64-bit käyttöjärjestelmä  

Oracle VM VirtualBox Manager

##

Läksy löytyy sivulta:  

https://terokarvinen.com/2023/eettinen-hakkerointi-2023/  

## x) Lue ja tiivistä  

Hoikkala "joohoi" 2020: [Still Fuzzing Faster (U fool)](https://www.youtube.com/watch?v=mbmsT3AhwWU). In HelSec Virtual meetup #1:  

- ffuf työkalun esittely ja muutama esimerkki demo muodossa
- fuzzauksella pyritään filtteröimään poikkeamia järjestelmistä haavoittuvuuksien löytämiseksi
- FUZZ sana parametreissä on "keyword" mikä pyritään löytämään wordlististä
- voidaan käyttää input kontenttien löytämisessä (salasanat, käyttäjänimet, API-polut, yleiset resurssipolut, parametrien nimet ja arvot)
- yleisempiä maaleja ovat GET parametrit (nimet, arvot tai molemmat), HEADERIT (host, authentication, cookies, proxy headers), ja POST data (form data, JSON,files)

##

Lyon 2009: Nmap Network Scanning: Chapter 15. Nmap Reference Guide  

[Port Scanning Basics](https://nmap.org/book/man-port-scanning-basics.html)  

Nmap tunnistaa 6 eri tilaa porteille  

- open tilassa applikaatio hyväksyy TCP yhteydet, UDP datagramit ja SCTP assosiaatiot kyseiseen porttiin. Tämä on yleisesti porttiskannauksen tärkein tavoite
- closed portti on tavoitettavissa Nmapilla (vastaanottaa ja vastaa pakettteihin) mutta mikään applikaatio ei kuuntele. Voivat olla hyödyllisiä tunnistettaessa, että host on kuitenkin ylhäällä ja portteja kannattaa myöhemmin mahdollisesti skannata uudestaan
- filtered Nmap ei pysty määrittämään onko portti auki koska pakettifiltteröinti estää pakettien saapumiseen portille. Tämä voi johtua esimerksi palomuurista. Filtered tila on huono hyökkääjälle, koska siitä ei saa juuri mitään informaatiota ja se hidastaa muuten skannausta.  

[Port Scanning Techniques](https://nmap.org/book/man-port-scanning-techniques.html)  

-sS (TCP SYN SCAN) kaikista suosituin monesta syystä. Nopea ja ei jätä helposti jälkiä koska ei päätä TCP yhteyttä loppuun asti (lähetetään SYN paketti ja odotetaan vaan vastausta)  

-sT (TCP connect scan) default TCP skannaus silloin kun SYN skannaus ei ole mahdollista. Tämä luo TCP yhteyden ja tietysti jättää myös jäljen logeihin.  

-sU (UDP scan)  UDP:llä voidaan skannata DNS, SNMP ja DHCP palveluita. UDP ei ole kovin suosittua koska se on hidasta mutta sitä kannattaa kuitenkin kokeilla tietyissä tilanteissa.  

## 

## a) Fuff

https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/?fromSearch=ffuf#your-turn---challenge

Tarkoitus on ratkaista Teron haastebinääri dirfuzt-1. 

Ladataan ensiksi binääri, huom ohjeista poiketen tiedoston nimi päättyy ykkösellä, eikä se ole esimerkin 0.  

![image](https://github.com/aarott/pentest23/assets/78908566/f1b133be-c122-4805-87e4-676e0ea7f7b8)  

![image](https://github.com/aarott/pentest23/assets/78908566/de60bd24-47ef-4adc-9507-20135a720082)  

Tarkistetaan haastebinääri on tosiaan ladattu ja toimii:  

![image](https://github.com/aarott/pentest23/assets/78908566/97243aa8-1486-4a41-8cb9-e05417031f22)  

##

Nyt asennetaan FFUF Teron sivun ohjeita käyttäen ja sen jälkeen ladataan Daniel Miesslerin tekemä wordlisti.  

![image](https://github.com/aarott/pentest23/assets/78908566/7802fee6-3b93-444c-bdf7-e9a7e925e270)  

![image](https://github.com/aarott/pentest23/assets/78908566/530b0441-343d-4463-a64c-101fdd831a8a)  

##

Tässä vaiheessa ohjeissa kehotetaan, että olisi hyvä laittaa netti pois päältä ennen kuin aletaan tekemään requesteja Ffuffilla. Tämä on varmasti ihan hyvä idea, ettei mitään vahinkoja vahingossa pääse tapahtumaan.
Menin Kali Linuxissa vasemmassa yläreunassa Ethernet connectionista painamaan Disconnect.

![image](https://github.com/aarott/pentest23/assets/78908566/cd1741f1-5a8d-4287-966e-0fa186c390f4)  

*** Tässä kohtaa kävi sellainen outo juttu, että yhtäkkiä en päässytkään enää 127.0.0.2:8000 sivulle. Yritin käynnistää ./dirtfuzt-1 binääriä uudestaan, mutta se ei jäänyt auki. Käynnistin Kali Linuxin uudelleen ja nyt näyttää toimivan. Jätin tuon pätkän yhteeen terminaali ikkunaan auki, samalla kun toisesta käytän fuffia.

![image](https://github.com/aarott/pentest23/assets/78908566/a02efb0f-16c5-43a9-a615-e633ff97ddda)

Ajoin nyt komennon:  

$ ./ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ 

-w tarkoittaa wordlistiä  
-u  url-osoitetta mitä fuzzataan  
FUZZ : on aina kohta mihin wordlististä kokeillaan eri sanoja


![image](https://github.com/aarott/pentest23/assets/78908566/ba633922-7982-42ea-8925-82ac935b7a74)  

![image](https://github.com/aarott/pentest23/assets/78908566/308a96dd-9e5d-4da0-9043-a645ae7a400c)


Kun sample tuloksia katsoo, huomataan että Status: 200 on kaikissa mutta Size: 154 tulee todella monessa vastaan. Ratkaisuksi kokeilen filtteröidä tuon kokoiset vastaukset pois.  
   
 -fs filtteröi tietyn kokoiset HTTP:vastaukset  

 Tässä tapauksessa ajetaan siis komento:  

 $ ./ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ  -fs154  

![image](https://github.com/aarott/pentest23/assets/78908566/56d8b4e2-da83-4f62-8452-e5549755f80f)

![image](https://github.com/aarott/pentest23/assets/78908566/32d59390-c8bc-4ad1-a746-4bd09cc5c38b)  

Tämä onnistui, sillä tuloksena löytyi git-versiohallinta sivustot ja admin sivusto. Kävin testaamassa selaimella admin-sivustoa.  

##

## b) Fuffme. Asenna Fuffme harjoitusmaali paikallisesti omalle koneellesi ja ratkaise tehtävät  

Fuffme - harjoitusmaalin asentamiseen ja tehtävien tekemiseen ohjeet joita käytin:  

https://terokarvinen.com/2023/fuffme-web-fuzzing-target-debian/  

![image](https://github.com/aarott/pentest23/assets/78908566/d5d54612-0050-4b69-8783-74a590654480)  

Ajoin kyseiset komennot terminaalissa. Kesti noin 5 minuuttia. Testasin sen jälkeen selaimella, että sivusto toimii localhostilla.  

![image](https://github.com/aarott/pentest23/assets/78908566/95a8aadb-7734-4bae-95d0-181d4bb2230a)  

![image](https://github.com/aarott/pentest23/assets/78908566/0cb3279a-cb54-4dc4-b1ed-95618168d84d)

##

Kävin sen jälkeen asentemassa alla olevat wordlistit kyseisillä komennoilla:  

![image](https://github.com/aarott/pentest23/assets/78908566/ab2130d5-36d0-489a-adee-7106b17f7e13)

##

Tämän jälkeen kävin taas sulkemassa netin Disconnect tilaan vasemmasta yläkulmasta, ettei vahinkoja pääse tapahtumaan vaikka maalit ovatkin localhostilla. 

##  

Näissä tehtävissä on tehtävänannossa selitetty hyvin mitä tulee tehdä, komento on listattu jne.  
Laitan kuvan tehtävästä ja sen jälkeen kuvan omasta terminaalista. Olin aiemmin käynyt jo läpi mitä esim  
-w , -u ja -fs voidaan tehdä. Uusissa tehtävissä tulee uusia ja lisään niihin jonku maininnan perään.  

##

![image](https://github.com/aarott/pentest23/assets/78908566/7d659889-e929-4713-bb10-fa010ba43f24)  

![image](https://github.com/aarott/pentest23/assets/78908566/7c90ebe3-d6fd-4130-9ca7-2efe62d8536f)  

class ja development.log löytyi  

##

![image](https://github.com/aarott/pentest23/assets/78908566/5584dbe5-5aad-480a-91b4-5df7442e98e1)  

![image](https://github.com/aarott/pentest23/assets/78908566/1c6f0601-9d98-4d99-ad84-4d23cb98fe89)  

Tässä käytetään -recursion mikä tarkoittaa että kun uusi hakemisto löytyy, scannaus jatkuu sen hakemiston sisällä. Näin ollen päästään vihdoin admin/users/96 hakjemistoon.  

##



![image](https://github.com/aarott/pentest23/assets/78908566/b94a93ad-f23f-4f2f-8fe4-738eeead1945)  

![image](https://github.com/aarott/pentest23/assets/78908566/393010de-bbab-4dac-b257-bb7c55a25daf)  

Tässä käytetään -e mikä määrittää mitä extension typeä laitetaan wordlistan jokaisen sanan perään. Tässä kun haetaan .log tiedostoa se on merkattu "-e .log" . Sieltä se user.log tiedosto löytyikin.  

##

![image](https://github.com/aarott/pentest23/assets/78908566/829711d1-61d3-41ec-8628-8d9fa55fa719)


![image](https://github.com/aarott/pentest23/assets/78908566/3ab02f11-2fe1-494b-80ec-296eee2aac6f)  

Tässä oli hyvä huomata kun etsittiin sivua mihin ei tulisi 404 not foundia, kun eka komento ajettiin niin kaikkien 404 not found sivustojen koko on 669 tavua. Niinpä filtteröidään -fs 669 komennolla 669 tavuiset sivut pois.

##  

![image](https://github.com/aarott/pentest23/assets/78908566/032e2212-7911-49a0-bcc2-42fe5fdcf7de)


![image](https://github.com/aarott/pentest23/assets/78908566/c6a1984f-d877-40ad-8666-009d126340db)

##  

![image](https://github.com/aarott/pentest23/assets/78908566/34f77361-9da3-4369-a9e8-feff37188ade)  


![image](https://github.com/aarott/pentest23/assets/78908566/d1d17080-c520-4197-b3d3-761ba295acfe)  

Tämä tehtävä ei toiminut enkä saanut vastausta vaikka komennnot on samat kuin sivulla. En osaa sanoa miksi. Ehkä "oracle" sanaa ei löydy wordlistasta tai sitten tämä on "broken demo".    

##


![image](https://github.com/aarott/pentest23/assets/78908566/eedb61b1-ef40-424c-b15c-2f5475a18871)  


![image](https://github.com/aarott/pentest23/assets/78908566/ad8a9d96-be2d-4eb4-ad5e-cb2e6593d38d)

Ekan komennon kun ajaa huomataan että kaikki tulokset tulevat 1495 tavulla, joten filtteröidään taas sellaiset vastaukset pois -fs 1495 komennolla.  

## Porttiskannaa paikallinen kone (127.0.0.2 tms), sieppaa liikenne snifferillä, analysoi.

Porttiskannataan paikallinen kone ja siepataan liikennettä snifferillä (Wireshark). Käytän Kali Linuxia missä Wireshark on asennettu valmiiksi.  

Asensin SSH palvelun ja käynnistin sen, että minulla olisi yksi avoin palvelu ja portti (22) auki näitä testejä varten.  

$ sudo apt-get update  
$ sudo apt-get install ssh   
$ sudo service ssh start  

Kävin terminaalista antamassa tavalliselle käyttäjälle oikeudet käyttää Wiresharkia.  

![image](https://github.com/aarott/pentest23/assets/78908566/082abbfc-8fa1-49ca-90ef-5e8ab4940163)  

Tämä olikin jo kunnossa eli jatkoin nyt ensimmäiseen skannaukseen.  

Tulen näissä skannauksissa Teron sivujen tehtävänannon vinkkien mukaan tekemään testit mahdollisimman suppeasti, jotta analysointi on helpompaa. Skannaan siis vain yhden portin koneesta, eli usein tuon yhden avoinaisen portin (SSH portti 22) ja ehkä jonku toisen kiinni olevan portin.  

Varmistukaseni onko tosiaan vain portti 22 auki koneessa tällä hetkellä ja mikä tilanne muutenkin tein ennen agressiivisen nmap testin: $ sudo nmap -A localhost:  

![image](https://github.com/aarott/pentest23/assets/78908566/3fdb5045-0dad-446c-aee5-7308a3e41634)  

Tilanne on siis kuten arvelin, portti 22 ainoastaan on auki.  

## c) nmap TCP connect scan -sT  

Skannaan nyt TCP connect scannilla portin numero 22. Samaan aikaan olen Wiresharkista valinnut Loopback:Io ja painan vasemmassa ylälaidassa olevaa hainevää snifferin käynnistämiseksi ennen kuin ajan komennon terminaalissa.  

![image](https://github.com/aarott/pentest23/assets/78908566/970698bd-91a8-44b2-a2a7-0431b728ed98)  

![image](https://github.com/aarott/pentest23/assets/78908566/18332252-9290-49eb-8c21-5f6fdad279f5)  

![image](https://github.com/aarott/pentest23/assets/78908566/2b6c3684-1f81-4bff-ba64-d92a3b808ea7)

Wiresharkista nähdään, että tässä tapahtuu onnistunut TCP 3-way handshake. Lähetämme ensiksi [SYN] paketin, mihin saamme vastauksen [SYN, ACK] paketin mikä tarkoittaa että portti on auki. Ihan viimeisellä rivillä punaisella voidaan nähdä että kone lähettää [RST,ACK] paketin, mikä tarkoittaa että yhteys suljetaan. 

Testiksi skannaan nyt portin mikä on kiinni (http 80) ja teen saman jutun kun äsken Wiresharkilla.  

![image](https://github.com/aarott/pentest23/assets/78908566/46374435-a7bf-4d24-a364-15bf13154b8e)  

![image](https://github.com/aarott/pentest23/assets/78908566/d715b6fc-b293-4f52-b6fd-ae5476c6c1af)  

Tästä voidaan huomata että koska [SYN, ACK] vastausta ei tule, tarkoittaa että portti on kiinni. 

Huom. Koska tämä on TCP connect scan, meidän kohde päättää aina yhteyden lähettämällä [RST, ACK] paketin takaisin, vaikka ei vastausta kuuluisikaan. 

## d) nmap TCP SYN "used to be stealth" scan, -sS  

-sS (TCP SYN SCAN) on kaikista suosituin monesta syystä. Nopea ja ei jätä helposti jälkiä koska ei päätä TCP yhteyttä loppuun asti (lähetetään SYN paketti ja odotetaan vaan vastausta)  

Kokeilen tätä nyt käytännössä taas samaan avoinaiseen porttiin ja katson wiresharkilla miten se eroaa äskeisestä tehtävästä:  

![image](https://github.com/aarott/pentest23/assets/78908566/9c02fe6a-bd08-4eb3-848a-bfeace6ddc21)  

![image](https://github.com/aarott/pentest23/assets/78908566/25483a14-83d2-4d1d-bb89-3dd5dff4ab88)  

Tästä voidaankin huomata, että vastauksen saatuamme [SYN, ACK] TCP yhteyttä ei viedä loppuun asti lähettämällä enää [RST,ACK] pakettia vaan pelkästään suljetaan yhteys [RST].  

## g) nmap version detection -sV

![image](https://github.com/aarott/pentest23/assets/78908566/5e990f42-dbfa-4ad3-8f86-14739749a999)  

![image](https://github.com/aarott/pentest23/assets/78908566/ce678d75-efb4-4afd-b48c-7d526d2251b0)  

Wiresharkista huomataan, että TCP yhteys on päätetty FIN - ACK menetelmällä mikä tarkoittaa että molemmat kohteet on päättänyt kommunikaation "yhteishengessä". Voidaan huomata myös että SSH yhteyttä on käytetty version detectioniin, kummassakin Wiresharkissa sekä Nmap tuloksesta saadaan selville että kyseessä on OpenSSH9.4 Debian -1.  

## h) nmap output files -oA foo  

![image](https://github.com/aarott/pentest23/assets/78908566/20d997b9-f038-421f-91aa-3ec467e19a12)  

![image](https://github.com/aarott/pentest23/assets/78908566/f8e6d75a-36f1-4e70-a79f-345a25d6370a)  

![image](https://github.com/aarott/pentest23/assets/78908566/9e7610dc-085d-463d-baa0-3f919eea7af2)  

Wiresharkilla vaikuttaa samanatyyppiseltä skannilta kuin esim -sS mikä päättyy heti vastauksen saatua eikä lähetä enää mitään takaisin.  Foo.nmap tiedostoihin jää tulokset skannauksesta kuten kuvassa.  










